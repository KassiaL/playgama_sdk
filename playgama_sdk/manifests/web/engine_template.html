<html>

<head>
    <script type="text/javascript">
		class SDKLoader {
				constructor() {
					this.externalURL = 'https://bridge.playgama.com/v1/stable/playgama-bridge.js';
					this.localFallback = './playgama-bridge.js';
					this.loadTimeout = 5000; // 5 secs
				}

				async load() {
					try {
						const loaded = await this.loadExternalWithTimeout();
						console.log('loadExternalWithTimeout', loaded);
						if (!loaded) {
							await this.loadLocal();
							console.log('loaded local 1');
						}
					} catch (error) {
						console.error('SDK loading failed:', error);
						await this.loadLocal();
						console.log('loaded local 2');
					}
				}

				loadExternalWithTimeout() {
					return new Promise((resolve) => {
						const timeoutId = setTimeout(() => {
							cleanup();
							resolve(false);
						}, this.loadTimeout);

						const script = document.createElement('script');

						const cleanup = () => {
							clearTimeout(timeoutId);
							script.onload = null;
							script.onerror = null;
						};

						script.onload = () => {
							cleanup();
							// Дополнительная проверка, что SDK действительно загрузился
							if (this.isSDKAvailable()) {
								resolve(true);
							} else {
								resolve(false);
							}
						};

						script.onerror = () => {
							cleanup();
							resolve(false);
						};

						script.src = this.externalURL;
						document.head.appendChild(script);
					});
				}

				loadLocal() {
					return new Promise((resolve, reject) => {
						const script = document.createElement('script');
						script.src = this.localFallback;
						script.onload = () => resolve();
						script.onerror = () => reject(new Error('Local SDK failed to load'));
						document.head.appendChild(script);
					});
				}

				isSDKAvailable() {
					// Проверяем наличие глобальных объектов SDK
					return bridge != undefined
				}
			}

			// Использование
			const loader = new SDKLoader();
			loader.load().then(() => {
				// console.log('SDK ready to use');
				
				window.is_bridge_inited = false
				bridge.initialize().then(() => {

					const AD_OPENED = 0
					const AD_CLOSED = 1
					const AD_REWARDED = 2
					const AD_FAILED = 3

					bridge.advertisement.on(
						bridge.EVENT_NAME.REWARDED_STATE_CHANGED,
						state => {
							if (state === "opened") JsToDef.send("rew_state", AD_OPENED)
							else if (state === "closed") JsToDef.send("rew_state", AD_CLOSED)
							else if (state === "rewarded") JsToDef.send("rew_state", AD_REWARDED)
							else if (state === "failed") JsToDef.send("rew_state", AD_FAILED)
						}
					)

					bridge.advertisement.on(
						bridge.EVENT_NAME.INTERSTITIAL_STATE_CHANGED,
						state => {
							if (state === "opened") JsToDef.send("inter_state", AD_OPENED)
							else if (state === "closed") JsToDef.send("inter_state", AD_CLOSED)
							else if (state === "failed") JsToDef.send("inter_state", AD_FAILED)
						}
					)

					window.is_bridge_inited = true

				}).catch(error => {
					console.log("error when initialize bridge");
					console.log(error);
				});
			});
    </script>
</head>

</html>